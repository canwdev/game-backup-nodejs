<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local JSON Config Editor</title>
  <style>
    :root {
      --bg-color: #f4f7f9;
      --main-color: #ffffff;
      --text-color: #333;
      --primary-color: #007bff;
      --primary-hover-color: #0056b3;
      --danger-color: #dc3545;
      --danger-hover-color: #c82333;
      --border-color: #ddd;
      --shadow-color: rgba(0,0,0,0.1);
      --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      height: 100vh
    }

    h1 {
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }
    h2 {
      margin-top: 0;
    }



    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .button {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s ease;
      color: white;
      background-color: #333333;
    }

    .button-primary { background-color: var(--primary-color); }
    .button-primary:hover { background-color: var(--primary-hover-color); }
    .button-danger { background-color: var(--danger-color); }
    .button-danger:hover { background-color: var(--danger-hover-color); }

    .container {
      display: flex;
      flex-grow: 1;
      gap: 16px;
      min-height: 0;
    }

    .panel {
      flex: 1;
      background-color: var(--main-color);
      border-radius: 8px;
      box-shadow: 0 2px 5px var(--shadow-color);
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .panel-header h2 {
      margin: 0;
    }

    .config-list-container {
      overflow-y: auto;
    }

    .config-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    .config-item:last-child {
      border-bottom: none;
    }
    .config-item-name {
      font-weight: 600;
    }
    .config-item-path {
      font-size: 0.9em;
      color: #666;
      word-break: break-all;
    }
    .config-item.disabled {
      opacity: 0.5;
      text-decoration: line-through;
    }
    .config-item-actions {
      display: flex;
      gap: 10px;
    }

    .raw-json-editor {
      flex-grow: 1;
      width: 100%;
      font-family: monospace;
      font-size: 14px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 10px;
      resize: vertical;
    }

    /* Dialog Styles */
    dialog {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 5px 15px var(--shadow-color);
      padding: 25px;
      width: 80%;
      max-width: 600px;
    }
    dialog::backdrop {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
    }
    .form-grid {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 15px;
      align-items: center;
    }
    .form-grid label {
      font-weight: 500;
      text-align: right;
    }
    .form-grid input[type="text"], .form-grid textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-sizing: border-box;
    }
    .form-grid textarea {
      height: 80px;
      resize: vertical;
      font-family: monospace;
    }
    .form-grid .checkbox-group {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .form-actions {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

  </style>
</head>
<body>
<h1>Local JSON Config Editor</h1>

<div class="toolbar">
  <button id="newBtn" class="button button-primary">New Config File</button>
  <button id="loadBtn" class="button button-primary">Load JSON File</button>
  <button id="saveBtn" class="button button-primary">Save JSON File</button>
</div>

<div class="container">
  <div class="panel">
    <div class="panel-header">
      <h2>Configurations</h2>
      <button id="addConfigBtn" class="button button-primary">Add New</button>
    </div>
    <div id="configList" class="config-list-container">
      <p>No configuration loaded. Click "Load JSON File" or "New Config File".</p>
    </div>
  </div>
  <div class="panel">
    <div class="panel-header">
      <h2>Raw JSON</h2>
      <button id="applyJsonBtn" class="button button-primary">Apply Changes</button>
    </div>
    <textarea id="rawJson" class="raw-json-editor" placeholder="Raw JSON will be displayed here..."></textarea>
  </div>
</div>

<dialog id="editDialog">
  <form id="editForm">
    <h2 id="dialogTitle">Edit Configuration</h2>
    <input type="hidden" name="index" value="-1">
    <div class="form-grid">
      <label for="name">Name:</label>
      <input type="text" id="name" name="name" required>

      <label for="srcPath">Source Path:</label>
      <input type="text" id="srcPath" name="srcPath" required>

      <label for="destPath">Destination Path:</label>
      <input type="text" id="destPath" name="destPath" placeholder="Optional. Default: ./backup/${name}">

      <label>Options:</label>
      <div class="checkbox-group">
        <label for="isGitBackup" style="text-align: left;"><input type="checkbox" id="isGitBackup" name="isGitBackup"> Use Git Backup</label>
        <label for="disabled" style="text-align: left;"><input type="checkbox" id="disabled" name="disabled"> Disabled</label>
      </div>

      <label for="exclude">Exclude:</label>
      <textarea id="exclude" name="exclude" placeholder="One pattern per line. Optional."></textarea>

      <label for="include">Include:</label>
      <textarea id="include" name="include" placeholder="One pattern per line. Optional."></textarea>
    </div>
    <div class="form-actions">
      <button type="button" id="cancelBtn" class="button">Cancel</button>
      <button type="submit" class="button button-primary">Save</button>
    </div>
  </form>
</dialog>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const appState = {
      configData: [],
      fileHandle: null,
      editingIndex: -1,
    };

    // DOM Elements
    const newBtn = document.getElementById('newBtn');
    const loadBtn = document.getElementById('loadBtn');
    const saveBtn = document.getElementById('saveBtn');
    const addConfigBtn = document.getElementById('addConfigBtn');
    const configList = document.getElementById('configList');
    const rawJson = document.getElementById('rawJson');
    const applyJsonBtn = document.getElementById('applyJsonBtn');
    const editDialog = document.getElementById('editDialog');
    const editForm = document.getElementById('editForm');
    const cancelBtn = document.getElementById('cancelBtn');
    const dialogTitle = document.getElementById('dialogTitle');

    // --- Core Logic ---

    /**
     * Renders the list of configurations on the left panel.
     */
    const renderConfigList = () => {
      if (appState.configData.length === 0) {
        configList.innerHTML = `<p>No configurations found. Click "Add New" to create one.</p>`;
        return;
      }

      configList.innerHTML = appState.configData.map((config, index) => `
                    <div class="config-item ${config.disabled ? 'disabled' : ''}">
                        <div>
                            <div class="config-item-name">${config.name}</div>
                            <div class="config-item-path">${config.srcPath}</div>
                        </div>
                        <div class="config-item-actions">
                            <button class="button button-primary" data-index="${index}" data-action="edit">Edit</button>
                            <button class="button button-danger" data-index="${index}" data-action="delete">Delete</button>
                        </div>
                    </div>
                `).join('');
    };

    /**
     * Renders the raw JSON in the right panel textarea.
     */
    const renderRawJson = () => {
      rawJson.value = JSON.stringify(appState.configData, null, 2);
    };

    /**
     * Updates both UI panels.
     */
    const updateUI = () => {
      renderConfigList();
      renderRawJson();
    };

    /**
     * Converts multiline string from textarea to string or array of strings.
     * @param {string} str - The input string from a textarea.
     * @returns {string|string[]|undefined}
     */
    const processMultiLineInput = (str) => {
      if (!str.trim()) return undefined;
      const lines = str.split('\n').map(s => s.trim()).filter(Boolean);
      if (lines.length === 0) return undefined;
      if (lines.length === 1) return lines[0];
      return lines;
    };

    /**
     * Converts a potential string or array into a multiline string for a textarea.
     * @param {string|string[]} data - The input data.
     * @returns {string}
     */
    const formatForTextarea = (data) => {
      if (Array.isArray(data)) {
        return data.join('\n');
      }
      return data || '';
    };

    // --- Event Handlers ---

    /**
     * Handles creating a new, empty configuration file state.
     */
    newBtn.addEventListener('click', () => {
      appState.configData = [];
      appState.fileHandle = null;
      updateUI();
      // alert('New configuration created. Add items and click "Save" to create a file.');
    });

    /**
     * Handles loading a JSON file from disk.
     */
    loadBtn.addEventListener('click', async () => {
      try {
        [appState.fileHandle] = await window.showOpenFilePicker({
          types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }],
        });
        const file = await appState.fileHandle.getFile();
        const content = await file.text();
        appState.configData = JSON.parse(content);
        updateUI();
      } catch (err) {
        if (err.name !== 'AbortError') {
          console.error('Error loading file:', err);
          alert(`Error loading file: ${err.message}`);
        }
      }
    });

    /**
     * Handles saving the current configuration to a JSON file.
     */
    saveBtn.addEventListener('click', async () => {
      try {
        // If no file handle exists, prompt for a new file location.
        if (!appState.fileHandle) {
          appState.fileHandle = await window.showSaveFilePicker({
            types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }],
          });
        }
        const writable = await appState.fileHandle.createWritable();
        await writable.write(JSON.stringify(appState.configData, null, 2));
        await writable.close();
        // alert('File saved successfully!');
      } catch (err) {
        if (err.name !== 'AbortError') {
          console.error('Error saving file:', err);
          alert(`Error saving file: ${err.message}`);
        }
      }
    });

    /**
     * Handles applying changes from the raw JSON editor.
     */
    applyJsonBtn.addEventListener('click', () => {
      try {
        const newConfigData = JSON.parse(rawJson.value);
        if (!Array.isArray(newConfigData)) {
          throw new Error("The root of the JSON must be an array.");
        }
        appState.configData = newConfigData;
        renderConfigList(); // Only update the list, keep the raw JSON as is.
        // alert('Raw JSON applied successfully.');
      } catch (err) {
        alert(`Invalid JSON: ${err.message}`);
      }
    });

    /**
     * Opens the edit dialog, either for a new or existing item.
     * @param {number} [index=-1] - The index of the item to edit. -1 for a new item.
     */
    const openEditDialog = (index = -1) => {
      appState.editingIndex = index;
      editForm.reset();
      if (index === -1) {
        dialogTitle.textContent = "Add New Configuration";
        editForm.elements.index.value = -1;
      } else {
        dialogTitle.textContent = "Edit Configuration";
        const config = appState.configData[index];
        editForm.elements.index.value = index;
        editForm.elements.name.value = config.name || '';
        editForm.elements.srcPath.value = config.srcPath || '';
        editForm.elements.destPath.value = config.destPath || '';
        editForm.elements.isGitBackup.checked = !!config.isGitBackup;
        editForm.elements.disabled.checked = !!config.disabled;
        editForm.elements.exclude.value = formatForTextarea(config.exclude);
        editForm.elements.include.value = formatForTextarea(config.include);
      }
      editDialog.showModal();
    };

    addConfigBtn.addEventListener('click', () => openEditDialog());

    cancelBtn.addEventListener('click', () => editDialog.close());

    /**
     * Handles clicks on the config list for edit/delete actions.
     */
    configList.addEventListener('click', (e) => {
      const button = e.target.closest('button');
      if (!button) return;

      const action = button.dataset.action;
      const index = parseInt(button.dataset.index, 10);

      if (action === 'edit') {
        openEditDialog(index);
      } else if (action === 'delete') {
        if (confirm(`Are you sure you want to delete "${appState.configData[index].name}"?`)) {
          appState.configData.splice(index, 1);
          updateUI();
        }
      }
    });

    /**
     * Handles form submission for adding/editing a configuration.
     */
    editForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const formData = new FormData(editForm);
      const index = parseInt(formData.get('index'), 10);

      const newConfig = {
        name: formData.get('name'),
        srcPath: formData.get('srcPath'),
        destPath: formData.get('destPath') || undefined,
        isGitBackup: formData.get('isGitBackup') === 'on' || undefined,
        disabled: formData.get('disabled') === 'on' || undefined,
        exclude: processMultiLineInput(formData.get('exclude')),
        include: processMultiLineInput(formData.get('include')),
      };

      // Clean up undefined properties
      Object.keys(newConfig).forEach(key => newConfig[key] === undefined && delete newConfig[key]);

      if (index === -1) { // Adding new
        appState.configData.push(newConfig);
      } else { // Updating existing
        appState.configData[index] = newConfig;
      }

      updateUI();
      editDialog.close();
    });

    // Initial render
    updateUI();
  });
</script>
</body>
</html>
